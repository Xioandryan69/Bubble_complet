!function(){"use strict";var e,n,t=tinymce.util.Tools.resolve("tinymce.PluginManager"),o=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),a=tinymce.util.Tools.resolve("tinymce.util.I18n"),r=tinymce.util.Tools.resolve("tinymce.util.Tools"),c=function(t){return t.getParam("toc_class","mce-toc")},u=function(t){t=t.getParam("toc_header","h2");return/^h[1-6]$/.test(t)?t:"h2"},i=function(t){t=parseInt(t.getParam("toc_depth","3"),10);return 1<=t&&t<=9?t:3},l=(e="mcetoc_",n=0,function(){var t=(new Date).getTime().toString(32);return e+t+(n++).toString(32)}),d=function(t){for(var e=[],n=1;n<=t;n++)e.push("h"+n);return e.join(",")},s=function(n){var o=c(n),t=u(n),e=d(i(n)),e=n.$(e);return e.length&&/^h[1-9]$/i.test(t)&&(e=e.filter(function(t,e){return!n.dom.hasClass(e.parentNode,o)})),r.map(e,function(t){var e=t.id;return{id:e||l(),level:parseInt(t.nodeName.replace(/^H/i,""),10),title:n.$.text(t),element:t}})},f=function(t){for(var e=9,n=0;n<t.length;n++)if(1===(e=t[n].level<e?t[n].level:e))return e;return e},m=function(t,e){var n="</"+t+">";return"<"+t+' contenteditable="true">'+o.DOM.encode(e)+n},v=function(t){var e="",n=s(t),o=f(n)-1;if(!n.length)return"";e+=m(u(t),a.translate("Table of Contents"));for(var r=0;r<n.length;r++){var i=n[r],c=(i.element.id=i.id,n[r+1]&&n[r+1].level);if(o===i.level)e+="<li>";else for(var l=o;l<i.level;l++)e+="<ul><li>";if(e+='<a href="#'+i.id+'">'+i.title+"</a>",c!==i.level&&c)for(l=i.level;c<l;l--)e+=l===c+1?"</li></ul><li>":"</li></ul>";else e+="</li>",c||(e+="</ul>");o=i.level}return e},g=function(t){var e,n=c(t),n=t.$("."+n);e=t,!(n=n).length||0<e.dom.getParents(n[0],".mce-offscreen-selection").length?t.insertContent((n=v(e=t),'<div class="'+e.dom.encode(c(e))+'" contenteditable="false">'+n+"</div>")):h(t)},h=function(t){var e=c(t),n=t.$("."+e);n.length&&t.undoManager.transact(function(){n.html(v(t))})},p=function(n){return function(t){function e(){return t.setDisabled(n.mode.isReadOnly()||!(0<s(n).length))}return e(),n.on("LoadContent SetContent change",e),function(){return n.on("LoadContent SetContent change",e)}}},y=function(e){return function(t){return t&&e.dom.is(t,"."+c(e))&&e.getBody().contains(t)}};t.add("toc",function(t){var e,n,o,r;function i(){return n.execCommand("mceInsertToc")}(e=t).addCommand("mceInsertToc",function(){g(e)}),e.addCommand("mceUpdateToc",function(){h(e)}),(n=t).ui.registry.addButton("toc",{icon:"toc",tooltip:"Table of contents",onAction:i,onSetup:p(n)}),n.ui.registry.addButton("tocupdate",{icon:"reload",tooltip:"Update",onAction:function(){return n.execCommand("mceUpdateToc")}}),n.ui.registry.addMenuItem("toc",{icon:"toc",text:"Table of contents",onAction:i,onSetup:p(n)}),n.ui.registry.addContextToolbar("toc",{items:"tocupdate",predicate:y(n),scope:"node",position:"node"}),o=(t=t).$,r=c(t),t.on("PreProcess",function(t){t=o("."+r,t.node);t.length&&(t.removeAttr("contentEditable"),t.find("[contenteditable]").removeAttr("contentEditable"))}),t.on("SetContent",function(){var t=o("."+r);t.length&&(t.attr("contentEditable",!1),t.children(":first-child").attr("contentEditable",!0))})})}();